<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>［顧客］詳細表示</title>
    <!-- Bootstrap CSSの読み込み -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>

<body>

    <div class="container mt-5">
        <h1 class="mb-4">［顧客］詳細表示</h1>
        <section>
            <h2 class="mb-4">顧客詳細</h2>
            <div class="table table-striped" id="customer-details">
                <!-- 顧客の詳細情報はここに挿入されます -->
            </div>
            <button class="btn btn-danger" id="deleteCustomerBtn">顧客を削除</button>
        </section><br><br>
        <form id="editCustomerForm">
            <h2 class="mb-4">顧客情報編集</h2>
            <div class="form-group">
                <label for="companyName">会社名</label>
                <input type="text" class="form-control" id="companyName" name="companyName" required>
            </div>
            <div class="form-group">
                <label for="industry">業種</label>
                <input type="text" class="form-control" id="industry" name="industry" required>
            </div>
            <div class="form-group">
                <label for="contact">連絡先</label>
                <input type="text" class="form-control" id="contact" name="contact" required>
            </div>
            <div class="form-group">
                <label for="location">所在地</label>
                <input type="text" class="form-control" id="location" name="location" required>
            </div>
            <button type="button" class="btn btn-primary mb-2" id="updateCustomerBtn">顧客情報を更新</button>
        </form>

        <h2 class="mb-4">案件登録</h2>
        <form action="submit_case.php" method="POST" id="addCaseForm">
            <input type="hidden" name="customer_id" value="<?php echo $_GET['customer_id']; ?>">
            <div class="form-group">
                <label for="case_name">案件名:</label>
                <input type="text" class="form-control" id="case_name" name="case_name" required>
            </div>
            <div class="form-group">
                <label for="case_status">状況:</label>
                <select class="form-control" id="case_status" name="case_status" required>
                    <option value="新規">新規</option>
                    <option value="交渉中">交渉中</option>
                    <option value="契約締結">契約締結</option>
                    <option value="失注">失注</option>
                </select>
            </div>
            <div class="form-group">
                <label for="expected_revenue">予想収益:</label>
                <input type="number" class="form-control" id="expected_revenue" name="expected_revenue" min="0"
                    step="0.01" required>
            </div>
            <div class="form-group">
                <label for="representative">代表者名:</label>
                <input type="text" class="form-control" id="representative" name="representative" required>
            </div>
            <input type="submit" class="btn btn-primary" value="登録">
        </form>

        <h2 class="mb-4">案件一覧</h2>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">状況</th>
                        <th scope="col">案件名</th>
                    </tr>
                </thead>
                <tbody id="case-list">
                    <!-- 案件一覧はここに挿入されます -->
                </tbody>
            </table>
        </div>
    </div>
    </div>

    <script type="module">
        // ExpressサーバのAPIエンドポイントのURL
        import config from "../config.js";

        // URLからcustomer_idを取得
        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('customer_id');
        // ************************************//
        // 顧客情報機能
        // ************************************//
        // 顧客詳細取得
        fetch(`${config.apiUrl}/customer/detail.html?customer_id=${customerId}`)
            .then((response) => response.json())
            .then((customer) => {
                const detailsContainer = document.getElementById("customer-details");
                // 顧客詳細を表形式で表示
                for (const [key, value] of Object.entries(customer.customer)) {
                    const row = document.createElement("tr");
                    const keyCell = document.createElement("td");
                    const valueCell = document.createElement("td");
                    // 列名を日本語に変更
                    const japaneseColumnName = mapToJapanese(key);
                    keyCell.textContent = japaneseColumnName;
                    valueCell.textContent = value;

                    row.appendChild(keyCell);
                    row.appendChild(valueCell);
                    detailsContainer.appendChild(row);
                }
                // 詳細データを編集フォームに入力
                document.getElementById("companyName").value = customer.customer.company_name;
                document.getElementById("industry").value = customer.customer.industry;
                document.getElementById("contact").value = customer.customer.contact;
                document.getElementById("location").value = customer.customer.location;
            })
            .catch((error) => console.error(error));

        // 列名を日本語に変換する関数
        function mapToJapanese(columnName) {
            const columnMap = {
                customer_id: '顧客ID',
                company_name: '会社名',
                industry: '業種',
                contact: '連絡先',
                location: '所在地',
                created_date: '登録日',
                updated_date: '更新日'
            };
            return columnMap[columnName] || columnName;
        }

        // 顧客情報編集
        document.getElementById("updateCustomerBtn").addEventListener("click", function () {
            const updateData = {
                companyName: document.getElementById("companyName").value,
                industry: document.getElementById("industry").value,
                contact: document.getElementById("contact").value,
                location: document.getElementById("location").value,
            };

            // 顧客情報編集後データを送信
            fetch(`${config.apiUrl}/customer/update?customer_id=${customerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData),
            })
                .then((response) => response.json())
                .then((data) => {
                    // 顧客情報編集が成功した場合の処理
                    alert("顧客情報が更新されました");
                    // 顧客一覧画面にリダイレクト
                    window.location.href = './list.html';
                })
                .catch((error) => {
                    // 顧客更新が失敗した場合の処理
                    console.error(error);
                    // 失敗時は通常通りのエラーメッセージ表示
                    alert("顧客情報の更新に失敗しました");
                });
        });

        // 顧客削除
        window.handleDeleteCustomer = function () {
            // 削除していいか確認
            const confirmation = confirm("顧客を削除してもよろしいですか？");

            if (confirmation) {
                // 顧客情報削除リクエストを送信
                fetch(`${config.apiUrl}/customer/delete?customer_id=${customerId}`, {
                    method: 'DELETE',
                })
                    .then((response) => response.json())
                    .then((data) => {
                        // 顧客削除が成功した場合の処理
                        alert("顧客が削除されました");
                        // 顧客一覧画面にリダイレクト
                        window.location.href = './list.html';
                    })
                    .catch((error) => {
                        // 顧客削除が失敗した場合の処理
                        console.error(error);
                        alert("顧客の削除に失敗しました");
                    });
            }
            console.log("handleDeleteCustomer function called");
        };
        // ボタンにイベントリスナーを追加
        document.getElementById("deleteCustomerBtn").addEventListener("click", handleDeleteCustomer);

        // ************************************//
        // 案件情報機能
        // ************************************//
        // 案件新規追加
        document.getElementById("addCaseForm").addEventListener("submit", function (event) {
            event.preventDefault(); // デフォルトのフォーム送信をキャンセル

            const formData = new FormData(this); // フォームデータを取得
            const case_name = formData.get('case_name');
            const case_status = formData.get('case_status');
            const expected_revenue = parseFloat(formData.get('expected_revenue'));
            const representative = formData.get('representative');
            // case_statusが正しい値かどうかを確認
            if (!['新規', '交渉中', '契約締結', '失注'].includes(case_status)) {
                alert('状況には「新規」「交渉中」「契約締結」「失注」のいずれかを指定してください');
                return;
            }

            // 案件新規追加リクエストを送信
            fetch(`${config.apiUrl}/customer/addCase`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    customer_id: customerId,
                    case_name: case_name,
                    case_status: case_status,
                    expected_revenue: expected_revenue,
                    representative: representative
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // 案件登録が成功した場合の処理
                    alert('案件が登録されました');
                    // 顧客詳細画面にリダイレクト
                    window.location.href = `detail.html?customer_id=${customerId}`;
                })
                .catch(error => {
                    // 案件登録が失敗した場合の処理
                    console.error('There has been a problem with your fetch operation:', error);
                    alert('案件の登録に失敗しました');
                    // 案件登録が失敗した場合もリダイレクト
                    window.location.href = `detail.html?customer_id=${customerId}`;
                });
        });

        // 案件一覧取得
        fetch(`${config.apiUrl}/customer/cases?customer_id=${customerId}`)
            .then((response) => response.json())
            .then((data) => {
                if (!data || !data.cases || !Array.isArray(data.cases)) {
                    throw new Error('Invalid data format');
                }

                const cases = data.cases;
                const caseListContainer = document.getElementById("case-list");
                if (cases.length === 0) {
                    const row = document.createElement("tr");
                    const messageCell = document.createElement("td");
                    messageCell.textContent = "案件情報はまだありません。";
                    messageCell.colSpan = 4; // メッセージセルを横幅いっぱいにする
                    row.appendChild(messageCell);
                    caseListContainer.appendChild(row);
                } else {
                    // 案件一覧を表形式で表示
                    cases.forEach((caseItem) => {
                        const row = document.createElement("tr");
                        const nameCell = document.createElement("td");
                        const statusCell = document.createElement("td");

                        // 空のカラムがあってもエラーが出ないように、存在するプロパティのみセットする
                        nameCell.textContent = caseItem.case_name || ' - ';
                        statusCell.textContent = caseItem.case_status || ' - ';

                        row.appendChild(nameCell);
                        row.appendChild(statusCell);

                        caseListContainer.appendChild(row);
                    });
                }
            })
            .catch((error) => console.error(error));
    </script>

    <!-- BootstrapのJavaScriptと依存関係のリンク -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="http://dev.marathon.rplearn.net/moka_sasaki/src/web/header.js"></script>
</body>

</html>